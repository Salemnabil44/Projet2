#!/bin/bash

# Fonction pour se connecter en SSH (inchangée)
connect_ssh() {
    echo "Connexion SSH en cours..."
    ssh $username@$hostname "echo Connexion SSH établie sur \`hostname\`"
    return $?
}

# Commande pour afficher les utilisateurs via SSH (inchangée)
show_users() {
    ssh $username@$hostname "awk -F: '\$3 >= 1000 && \$1 != \"nobody\" {print \$1}' /etc/passwd"
}

# Fonction pour ajouter un utilisateur via SSH (inchangée)
add_user() {
    read -p "Entrez le nom de l'utilisateur à ajouter : " user_to_add
    read -s -p "Entrez le mot de passe sudo pour $username@$hostname : " password
    echo ""
    echo "Ajout de l'utilisateur $user_to_add..."
    ssh $username@$hostname "echo '$password' | sudo -S useradd $user_to_add"
    if [ $? -eq 0 ]; then
        echo "Utilisateur $user_to_add créé avec succès."
    else
        echo "Échec de la création de l'utilisateur $user_to_add."
    fi
}

# Fonction pour supprimer un utilisateur via SSH (inchangée)
delete_user() {
    read -p "Entrez le nom de l'utilisateur à supprimer : " user_to_delete
    read -s -p "Entrez le mot de passe sudo pour $username@$hostname : " password
    echo ""
    echo "Suppression de l'utilisateur $user_to_delete..."
    ssh $username@$hostname "echo '$password' | sudo -S deluser $user_to_delete"
    if [ $? -eq 0 ]; then
        echo "Utilisateur $user_to_delete supprimé avec succès."
    else
        echo "Échec de la suppression de l'utilisateur $user_to_delete."
    fi
}

# Nouvelle fonction pour éteindre le serveur via SSH avec confirmation
shutdown_server() {
    read -p "Êtes-vous sûr de vouloir éteindre le serveur ? Vous ne pourrez pas rallumer le serveur à distance (oui/non) : " confirm
    if [ "$confirm" = "oui" ]; then
        echo "Extinction du serveur en cours..."
        ssh $username@$hostname "sudo shutdown -h now"
        if [ $? -ne 0 ]; then
            echo "Le serveur a été éteint avec succès."
        else
            echo "Échec de l'extinction du serveur."
        fi
    else
        echo "Annulation de l'extinction du serveur."
    fi
}

# Nouvelle fonction pour redémarrer le serveur via SSH
restart_server() {
    echo "Redémarrage du serveur en cours..."
    ssh $username@$hostname "sudo shutdown -r now"
    if [ $? -ne 0 ]; then
        echo "Le serveur a redémarré avec succès. Veuillez rétablir une connexion SSH en relançant le script."
    else
        echo "Échec du redémarrage du serveur."
    fi
}

# Fonction pour afficher le menu (inchangée, mais étendue avec les nouvelles options)
show_menu() {
    echo ""
    echo "Menu :"
    echo "1. Ajouter un utilisateur"
    echo "2. Supprimer un utilisateur"
    echo "3. Afficher les utilisateurs"
    echo "4. Éteindre le serveur"
    echo "5. Redémarrer le serveur"
    echo "6. Quitter"
}

# Demander les identifiants SSH (inchangé)
echo "Entrez les informations de connexion SSH :"
read -p "Nom d'utilisateur : " username
read -p "Adresse IP ou nom de domaine : " hostname

# Boucle pour la connexion SSH (inchangée)
while ! connect_ssh; do
    echo "Échec de la connexion SSH. Veuillez réessayer."
    read -p "Nom d'utilisateur : " username
    read -p "Adresse IP ou nom de domaine : " hostname
done

echo "Connexion établie avec succès!"

# Afficher le menu principal
while true; do
    show_menu

    read -p "Choisissez une option (1/2/3/4/5/6) : " choice
    case $choice in
        1)
            echo "Option 1 : Ajouter un utilisateur"
            add_user
            ;;
        2)
            echo "Option 2 : Supprimer un utilisateur"
            delete_user
            ;;
        3)
            echo "Option 3 : Afficher les utilisateurs"
            echo "Liste des utilisateurs sur $hostname :"
            show_users
            ;;
        4)
            echo "Option 4 : Éteindre le serveur"
            shutdown_server
            ;;
        5)
            echo "Option 5 : Redémarrer le serveur"
            restart_server
            ;;
        6)
            echo "Option 6 : Au revoir!"
            break
            ;;
        *)
            echo "Choix invalide. Veuillez choisir une option valide."
            ;;
    esac
done
