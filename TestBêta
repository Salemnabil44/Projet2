#!/bin/bash

# Fonction pour se connecter en SSH
connect_ssh() {
    echo "Connexion SSH en cours..."
    ssh $username@$hostname "echo Connexion SSH établie sur \`hostname\`"
    return $?
}

# Commande pour afficher les utilisateurs via SSH
show_users() {
    ssh $username@$hostname "awk -F: '\$3 >= 1000 && \$1 != \"nobody\" {print \$1}' /etc/passwd"
}

# Fonction pour supprimer un utilisateur via SSH
delete_user() {
    read -p "Entrez le nom de l'utilisateur à supprimer : " user_to_delete
    read -s -p "Entrez le mot de passe sudo pour $username@$hostname : " password
    echo ""
    echo "Suppression de l'utilisateur $user_to_delete..."
    ssh $username@$hostname "echo '$password' | sudo -S deluser $user_to_delete"
}

# Fonction pour afficher les informations système
display_system_info() {
    echo "Recueil des informations système..."
    sys_info=$(ssh $username@$hostname "echo 'Nom d'utilisateur: $username'; echo 'Architecture processeur: \$(uname -m)'; echo 'Taille du disque dur: \$(df -h / | awk 'NR==2{print \$2}')'; echo 'Espace utilisé: \$(df -h / | awk 'NR==2{print \$3}')'; echo 'Mémoire vive: \$(free -h | awk '/Mem:/{print \$2}')'; echo 'Adresse IP: \$(hostname -I | awk '{print \$1}')'")

    echo "$sys_info"

    read -p "Enregistrer les informations dans Documents (1) ou sur le Bureau (2) ? " save_choice
    if [[ $save_choice -eq 1 ]]; then
        save_dir="$HOME/Documents"
    elif [[ $save_choice -eq 2 ]]; then
        save_dir="$HOME/Desktop"
    else
        echo "Choix invalide. Les informations ne seront pas enregistrées."
        return
    fi

    target_name=$(ssh $username@$hostname "hostname")
    date_str=$(date +%Y%m%d)
    file_name="info_${target_name}_${date_str}.txt"
    file_path="$save_dir/$file_name"

    echo "$sys_info" > "$file_path"
    echo "Informations enregistrées dans $file_path"
}

# Fonction pour afficher le menu
show_menu() {
    echo ""
    echo "Menu :"
    echo "1. Ajouter un utilisateur"
    echo "2. Supprimer un utilisateur"
    echo "3. Afficher les utilisateurs"
    echo "4. Afficher les informations système"
    echo "5. Quitter"
}

# Demander les identifiants SSH
echo "Entrez les informations de connexion SSH :"
read -p "Nom d'utilisateur : " username
read -p "Adresse IP ou nom de domaine : " hostname

# Boucle pour la connexion SSH
while ! connect_ssh; do
    echo "Échec de la connexion SSH. Veuillez réessayer."
    read -p "Nom d'utilisateur : " username
    read -p "Adresse IP ou nom de domaine : " hostname
done

echo "Connexion établie avec succès!"

# Afficher le menu principal
while true; do
    show_menu

    read -p "Choisissez une option (1/2/3/4/5) : " choice
    case $choice in
        1)
            echo "Option 1 : Ajouter un utilisateur"
            # Ajouter ici le code pour ajouter un utilisateur
            ;;
        2)
            echo "Option 2 : Supprimer un utilisateur"
            delete_user
            ;;
        3)
            echo "Option 3 : Afficher les utilisateurs"
            echo "Liste des utilisateurs sur $hostname :"
            show_users
            ;;
        4)
            echo "Option 4 : Afficher les informations système"
            display_system_info
            ;;
        5)
            echo "Choix 5 : Au revoir!"
            break
            ;;
        *)
            echo "Choix invalide. Veuillez choisir une option valide."
            ;;
    esac
done
